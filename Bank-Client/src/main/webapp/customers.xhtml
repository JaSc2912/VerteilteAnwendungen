<!DOCTYPE html>
<html
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
  xmlns:h="http://xmlns.jcp.org/jsf/html"
  xmlns:p="http://primefaces.org/ui"
  xmlns:f="http://xmlns.jcp.org/jsf/core"
>
  <ui:composition template="/templates/layout.xhtml">
    <ui:define name="title">Kunden - Bank-Client</ui:define>

    <ui:define name="content">
      <f:metadata>
        <f:viewAction
          action="#{sessionService.loggedIn ? '' : 'index?faces-redirect=true'}"
        />
        <f:viewAction action="#{customerBean.init}" />
      </f:metadata>

      <div class="card">
        <div class="card-header">
          <h1 class="card-title">Kundenverwaltung</h1>
        </div>

        <!-- Search and Actions -->
        <h:form id="searchForm">
          <div class="form-grid form-grid-2" style="align-items: end">
            <div>
              <p:outputLabel for="searchTerm" value="Suche:" />
              <p:inputText
                id="searchTerm"
                value="#{customerBean.searchTerm}"
                placeholder="Name oder E-Mail eingeben"
              />
            </div>
            <div style="display: flex; gap: 0.5rem">
              <p:commandButton
                value="Suchen"
                action="#{customerBean.searchCustomers}"
                update="customersTable"
                icon="pi pi-search"
              />
              <p:commandButton
                value="Alle anzeigen"
                action="#{customerBean.loadCustomers}"
                update="customersTable"
                icon="pi pi-refresh"
              />
              <p:commandButton
                value="Neuer Kunde"
                action="#{customerBean.createCustomer}"
                oncomplete="PF('customerDialog').show()"
                update="customerDialog"
                styleClass="ui-button-success"
                icon="pi pi-plus"
              />
            </div>
          </div>
        </h:form>

        <!-- Customers Table -->
        <h:form id="customersForm">
          <p:dataTable
            id="customersTable"
            value="#{customerBean.customers}"
            var="customer"
            styleClass="data-table"
            paginator="true"
            rows="10"
            paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
            rowsPerPageTemplate="10,25,50"
          >
            <p:column
              headerText="Kundennummer"
              sortBy="#{customer.kundennummer}"
            >
              <h:outputText value="#{customer.kundennummer}" />
            </p:column>

            <p:column headerText="Name" sortBy="#{customer.name}">
              <h:outputText value="#{customer.name}" />
            </p:column>

            <p:column headerText="E-Mail" sortBy="#{customer.email}">
              <h:outputText value="#{customer.email}" />
            </p:column>

            <p:column headerText="Telefon">
              <h:outputText value="#{customer.telefonnummer}" />
            </p:column>

            <p:column headerText="Status" sortBy="#{customer.kundenstatus}">
              <p:tag
                value="#{customer.kundenstatus}"
                severity="#{customer.kundenstatus eq 'AKTIV' ? 'success' : 'danger'}"
              />
            </p:column>

            <p:column headerText="Aktionen" width="150">
              <p:commandButton
                icon="pi pi-pencil"
                title="Bearbeiten"
                action="#{customerBean.editCustomer(customer)}"
                oncomplete="PF('customerDialog').show()"
                update="customerDialog"
                styleClass="ui-button-warning"
              />

              <p:commandButton
                icon="pi pi-trash"
                title="Löschen"
                action="#{customerBean.deleteCustomer(customer)}"
                update="customersTable"
                styleClass="ui-button-danger"
                style="margin-left: 0.5rem"
              >
                <p:confirm
                  header="Bestätigung"
                  message="Möchten Sie den Kunden wirklich löschen?"
                  icon="pi pi-exclamation-triangle"
                />
              </p:commandButton>
            </p:column>
          </p:dataTable>
        </h:form>
      </div>

      <!-- Customer Dialog -->
      <p:dialog
        id="customerDialog"
        widgetVar="customerDialog"
        modal="true"
        resizable="false"
        header="#{customerBean.editMode ? 'Kunde bearbeiten' : 'Neuer Kunde'}"
        width="500"
      >
        <h:form id="customerForm">
          <div class="form-grid">
            <p:outputLabel for="name" value="Name:*" />
            <p:inputText
              id="name"
              value="#{customerBean.selectedCustomer.name}"
              required="true"
              requiredMessage="Name ist erforderlich"
            />

            <p:outputLabel for="email" value="E-Mail:*" />
            <p:inputText
              id="email"
              value="#{customerBean.selectedCustomer.email}"
              required="true"
              requiredMessage="E-Mail ist erforderlich"
            />

            <p:outputLabel for="address" value="Adresse:" />
            <p:inputTextarea
              id="address"
              value="#{customerBean.selectedCustomer.adresse}"
              rows="3"
            />

            <p:outputLabel for="phone" value="Telefonnummer:" />
            <p:inputText
              id="phone"
              value="#{customerBean.selectedCustomer.telefonnummer}"
            />

            <p:outputLabel for="birthdate" value="Geburtsdatum:" />
            <p:calendar
              id="birthdate"
              value="#{customerBean.selectedCustomer.geburtsdatum}"
              pattern="dd.MM.yyyy"
              showOn="button"
            />
          </div>

          <div class="form-buttons">
            <p:commandButton
              value="Abbrechen"
              onclick="PF('customerDialog').hide()"
              type="button"
              styleClass="ui-button-secondary"
            />
            <p:commandButton
              value="Speichern"
              action="#{customerBean.saveCustomer}"
              update="customersForm:customersTable"
              oncomplete="if (args && !args.validationFailed) PF('customerDialog').hide()"
              styleClass="ui-button-success"
            />
          </div>
        </h:form>
      </p:dialog>

      <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
        <p:commandButton
          value="Ja"
          type="button"
          styleClass="ui-confirmdialog-yes"
          icon="pi pi-check"
        />
        <p:commandButton
          value="Nein"
          type="button"
          styleClass="ui-confirmdialog-no ui-button-secondary"
          icon="pi pi-times"
        />
      </p:confirmDialog>
    </ui:define>
  </ui:composition>
</html>
